import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
dotenv.config();

const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);

async function testWorkaroundFlow() {
  console.log('ðŸ§ª Testing workaround flow (create then update)...');
  
  try {
    // Step 1: Create moment WITHOUT publish flags to avoid trigger
    console.log('\n1ï¸âƒ£ Creating moment without publish flags...');
    
    const momentData = {
      title: 'Workaround Test Moment',
      content: 'This moment tests the workaround flow to avoid trigger issues.',
      region: 'KZN',
      category: 'Technology',
      status: 'draft',
      created_by: 'admin',
      content_source: 'admin'
      // No publish flags initially
    };
    
    const { data: moment, error: momentError } = await supabase
      .from('moments')
      .insert(momentData)
      .select()
      .single();
    
    if (momentError) {
      console.error('âŒ Failed to create moment:', momentError.message);
      return false;
    }
    
    console.log('âœ… Moment created:', moment.id);
    
    // Step 2: Update moment with publish flags
    console.log('\n2ï¸âƒ£ Updating moment with publish flags...');
    
    const { data: updatedMoment, error: updateError } = await supabase
      .from('moments')
      .update({\n        publish_to_whatsapp: true,\n        publish_to_pwa: true\n      })\n      .eq('id', moment.id)\n      .select()\n      .single();\n    \n    if (updateError) {\n      console.error('âŒ Failed to update moment:', updateError.message);\n      return false;\n    }\n    \n    console.log('âœ… Moment updated with publish flags');\n    \n    // Step 3: Create intents manually\n    console.log('\n3ï¸âƒ£ Creating intents manually...');\n    \n    const intentsToCreate = [];\n    \n    // PWA intent\n    intentsToCreate.push({\n      moment_id: updatedMoment.id,\n      channel: 'pwa',\n      action: 'publish',\n      status: 'pending',\n      payload: {\n        title: updatedMoment.title,\n        full_text: updatedMoment.content,\n        link: `https://moments.unamifoundation.org/m/${updatedMoment.id}`\n      }\n    });\n    \n    // WhatsApp intent\n    intentsToCreate.push({\n      moment_id: updatedMoment.id,\n      channel: 'whatsapp',\n      action: 'publish',\n      status: 'pending',\n      template_id: 'marketing_v1',\n      payload: {\n        title: updatedMoment.title,\n        summary: updatedMoment.content.substring(0, 100) + '...',\n        link: `https://moments.unamifoundation.org/m/${updatedMoment.id}`\n      }\n    });\n    \n    const { data: createdIntents, error: intentsError } = await supabase\n      .from('moment_intents')\n      .insert(intentsToCreate)\n      .select();\n    \n    if (intentsError) {\n      console.error('âŒ Failed to create intents:', intentsError.message);\n      return false;\n    }\n    \n    console.log(`âœ… Created ${createdIntents.length} intents`);\n    \n    // Step 4: Simulate n8n processing\n    console.log('\n4ï¸âƒ£ Simulating n8n processing...');\n    \n    for (const intent of createdIntents) {\n      const { error: updateError } = await supabase\n        .from('moment_intents')\n        .update({\n          status: 'sent',\n          attempts: 1,\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', intent.id);\n      \n      if (updateError) {\n        console.error(`âŒ Failed to update intent ${intent.id}:`, updateError.message);\n      } else {\n        console.log(`âœ… Processed ${intent.channel} intent`);\n      }\n    }\n    \n    // Step 5: Verify final state\n    console.log('\n5ï¸âƒ£ Verifying final state...');\n    \n    const { data: finalIntents } = await supabase\n      .from('moment_intents')\n      .select('*')\n      .eq('moment_id', updatedMoment.id);\n    \n    const sentCount = finalIntents.filter(i => i.status === 'sent').length;\n    const totalCount = finalIntents.length;\n    \n    console.log(`ðŸ“Š Final state: ${sentCount}/${totalCount} intents sent`);\n    console.log('ðŸ“‹ Intent details:', finalIntents.map(i => `${i.channel}:${i.status}`));\n    \n    // Cleanup\n    console.log('\nðŸ§¹ Cleaning up test data...');\n    await supabase.from('moment_intents').delete().eq('moment_id', updatedMoment.id);\n    await supabase.from('moments').delete().eq('id', updatedMoment.id);\n    console.log('âœ… Cleanup complete');\n    \n    return sentCount === totalCount && totalCount > 0;\n    \n  } catch (error) {\n    console.error('âŒ Test failed:', error.message);\n    return false;\n  }\n}\n\ntestWorkaroundFlow().then(success => {\n  console.log(success ? '\nðŸŽ‰ Workaround flow test PASSED' : '\nðŸ’¥ Workaround flow test FAILED');\n  process.exit(success ? 0 : 1);\n});", "oldStr": "import { createClient } from '@supabase/supabase-js';\nimport dotenv from 'dotenv';\ndotenv.config();\n\nconst supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);\n\nasync function testWorkaroundFlow() {\n  console.log('ðŸ§ª Testing workaround flow (create then update)...');\n  \n  try {\n    // Step 1: Create moment WITHOUT publish flags to avoid trigger\n    console.log('\\n1ï¸âƒ£ Creating moment without publish flags...');\n    \n    const momentData = {\n      title: 'Workaround Test Moment',\n      content: 'This moment tests the workaround flow to avoid trigger issues.',\n      region: 'KZN',\n      category: 'Technology',\n      status: 'draft',\n      created_by: 'admin',\n      content_source: 'admin'\n      // No publish flags initially\n    };\n    \n    const { data: moment, error: momentError } = await supabase\n      .from('moments')\n      .insert(momentData)\n      .select()\n      .single();\n    \n    if (momentError) {\n      console.error('âŒ Failed to create moment:', momentError.message);\n      return false;\n    }\n    \n    console.log('âœ… Moment created:', moment.id);\n    \n    // Step 2: Update moment with publish flags\n    console.log('\\n2ï¸âƒ£ Updating moment with publish flags...');\n    \n    const { data: updatedMoment, error: updateError } = await supabase\n      .from('moments')\n      .update({\n        publish_to_whatsapp: true,\n        publish_to_pwa: true\n      })\n      .eq('id', moment.id)\n      .select()\n      .single();\n    \n    if (updateError) {\n      console.error('âŒ Failed to update moment:', updateError.message);\n      return false;\n    }\n    \n    console.log('âœ… Moment updated with publish flags');\n    \n    // Step 3: Create intents manually\n    console.log('\\n3ï¸âƒ£ Creating intents manually...');\n    \n    const intentsToCreate = [];\n    \n    // PWA intent\n    intentsToCreate.push({\n      moment_id: updatedMoment.id,\n      channel: 'pwa',\n      action: 'publish',\n      status: 'pending',\n      payload: {\n        title: updatedMoment.title,\n        full_text: updatedMoment.content,\n        link: `https://moments.unamifoundation.org/m/${updatedMoment.id}`\n      }\n    });\n    \n    // WhatsApp intent\n    intentsToCreate.push({\n      moment_id: updatedMoment.id,\n      channel: 'whatsapp',\n      action: 'publish',\n      status: 'pending',\n      template_id: 'marketing_v1',\n      payload: {\n        title: updatedMoment.title,\n        summary: updatedMoment.content.substring(0, 100) + '...',\n        link: `https://moments.unamifoundation.org/m/${updatedMoment.id}`\n      }\n    });\n    \n    const { data: createdIntents, error: intentsError } = await supabase\n      .from('moment_intents')\n      .insert(intentsToCreate)\n      .select();\n    \n    if (intentsError) {\n      console.error('âŒ Failed to create intents:', intentsError.message);\n      return false;\n    }\n    \n    console.log(`âœ… Created ${createdIntents.length} intents`);\n    \n    // Step 4: Simulate n8n processing\n    console.log('\\n4ï¸âƒ£ Simulating n8n processing...');\n    \n    for (const intent of createdIntents) {\n      const { error: updateError } = await supabase\n        .from('moment_intents')\n        .update({\n          status: 'sent',\n          attempts: 1,\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', intent.id);\n      \n      if (updateError) {\n        console.error(`âŒ Failed to update intent ${intent.id}:`, updateError.message);\n      } else {\n        console.log(`âœ… Processed ${intent.channel} intent`);\n      }\n    }\n    \n    // Step 5: Verify final state\n    console.log('\\n5ï¸âƒ£ Verifying final state...');\n    \n    const { data: finalIntents } = await supabase\n      .from('moment_intents')\n      .select('*')\n      .eq('moment_id', updatedMoment.id);\n    \n    const sentCount = finalIntents.filter(i => i.status === 'sent').length;\n    const totalCount = finalIntents.length;\n    \n    console.log(`ðŸ“Š Final state: ${sentCount}/${totalCount} intents sent`);\n    console.log('ðŸ“‹ Intent details:', finalIntents.map(i => `${i.channel}:${i.status}`));\n    \n    // Cleanup\n    console.log('\\nðŸ§¹ Cleaning up test data...');\n    await supabase.from('moment_intents').delete().eq('moment_id', updatedMoment.id);\n    await supabase.from('moments').delete().eq('id', updatedMoment.id);\n    console.log('âœ… Cleanup complete');\n    \n    return sentCount === totalCount && totalCount > 0;\n    \n  } catch (error) {\n    console.error('âŒ Test failed:', error.message);\n    return false;\n  }\n}\n\ntestWorkaroundFlow().then(success => {\n  console.log(success ? '\\nðŸŽ‰ Workaround flow test PASSED' : '\\nðŸ’¥ Workaround flow test FAILED');\n  process.exit(success ? 0 : 1);\n});"}]
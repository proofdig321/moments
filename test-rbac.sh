#!/bin/bash\n\n# Test RBAC Setup for Unami Foundation Moments\n# This script tests the auth and RBAC implementation\n\necho \"üîê Testing RBAC Setup for Unami Foundation Moments\"\necho \"================================================\"\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nNC='\\033[0m' # No Color\n\n# Test results\nPASSED=0\nFAILED=0\n\n# Function to test endpoint\ntest_endpoint() {\n    local method=$1\n    local url=$2\n    local expected_status=$3\n    local description=$4\n    local auth_header=${5:-\"\"}\n    \n    echo -n \"Testing $description... \"\n    \n    if command -v curl >/dev/null 2>&1; then\n        if [ -n \"$auth_header\" ]; then\n            response=$(curl -s -o /dev/null -w \"%{http_code}\" -X \"$method\" \"$url\" -H \"$auth_header\" 2>/dev/null)\n        else\n            response=$(curl -s -o /dev/null -w \"%{http_code}\" -X \"$method\" \"$url\" 2>/dev/null)\n        fi\n        \n        if [ \"$response\" = \"$expected_status\" ]; then\n            echo -e \"${GREEN}‚úÖ PASS${NC} ($response)\"\n            ((PASSED++))\n        else\n            echo -e \"${RED}‚ùå FAIL${NC} (got $response, expected $expected_status)\"\n            ((FAILED++))\n        fi\n    else\n        echo -e \"${YELLOW}‚ö†Ô∏è  SKIP${NC} (curl not available)\"\n    fi\n}\n\n# Function to test file exists\ntest_file() {\n    local file=$1\n    local description=$2\n    \n    echo -n \"Testing $description... \"\n    \n    if [ -f \"$file\" ]; then\n        echo -e \"${GREEN}‚úÖ PASS${NC}\"\n        ((PASSED++))\n    else\n        echo -e \"${RED}‚ùå FAIL${NC} (file not found: $file)\"\n        ((FAILED++))\n    fi\n}\n\n# Function to test SQL file syntax\ntest_sql_syntax() {\n    local file=$1\n    local description=$2\n    \n    echo -n \"Testing $description... \"\n    \n    if [ -f \"$file\" ]; then\n        # Basic SQL syntax check - look for common issues\n        if grep -q \"CREATE TABLE\\|CREATE FUNCTION\\|CREATE POLICY\" \"$file\" && \n           ! grep -q \"syntax error\\|ERROR\" \"$file\"; then\n            echo -e \"${GREEN}‚úÖ PASS${NC}\"\n            ((PASSED++))\n        else\n            echo -e \"${RED}‚ùå FAIL${NC} (SQL syntax issues detected)\"\n            ((FAILED++))\n        fi\n    else\n        echo -e \"${RED}‚ùå FAIL${NC} (file not found: $file)\"\n        ((FAILED++))\n    fi\n}\n\n# Start testing\necho \"üìÅ Testing RBAC Files\"\necho \"-------------------\"\n\n# Test RBAC files exist\ntest_file \"supabase/rbac-complete.sql\" \"RBAC complete schema file\"\ntest_file \"supabase/rbac.sql\" \"RBAC policies file\"\ntest_file \"supabase/RBAC_SETUP.md\" \"RBAC setup documentation\"\ntest_file \"scripts/seed_superadmin.sh\" \"Superadmin seed script\"\ntest_file \"src/auth.js\" \"Auth middleware\"\ntest_file \"tests/auth-campaign.test.js\" \"Auth test suite\"\n\necho \"\"\necho \"üìù Testing SQL Syntax\"\necho \"--------------------\"\n\n# Test SQL files for basic syntax\ntest_sql_syntax \"supabase/rbac-complete.sql\" \"RBAC schema SQL syntax\"\ntest_sql_syntax \"supabase/rbac.sql\" \"RBAC policies SQL syntax\"\n\necho \"\"\necho \"üîß Testing Script Permissions\"\necho \"-----------------------------\"\n\n# Test script is executable\nif [ -x \"scripts/seed_superadmin.sh\" ]; then\n    echo -e \"Seed script executable... ${GREEN}‚úÖ PASS${NC}\"\n    ((PASSED++))\nelse\n    echo -e \"Seed script executable... ${RED}‚ùå FAIL${NC}\"\n    ((FAILED++))\nfi\n\necho \"\"\necho \"üåê Testing API Endpoints (if server running)\"\necho \"--------------------------------------------\"\n\n# Test server endpoints\nBASE_URL=\"http://localhost:8080\"\n\n# Test public endpoints work\ntest_endpoint \"GET\" \"$BASE_URL/health\" \"200\" \"Health endpoint (public)\"\n\n# Test admin endpoints require auth\ntest_endpoint \"GET\" \"$BASE_URL/admin/moments\" \"401\" \"Moments endpoint (no auth)\"\ntest_endpoint \"POST\" \"$BASE_URL/admin/moments\" \"401\" \"Create moment (no auth)\"\ntest_endpoint \"GET\" \"$BASE_URL/admin/broadcasts\" \"401\" \"Broadcasts endpoint (no auth)\"\ntest_endpoint \"GET\" \"$BASE_URL/admin/sponsors\" \"401\" \"Sponsors endpoint (no auth)\"\ntest_endpoint \"GET\" \"$BASE_URL/admin/analytics\" \"401\" \"Analytics endpoint (no auth)\"\ntest_endpoint \"GET\" \"$BASE_URL/admin/roles\" \"401\" \"Roles endpoint (no auth)\"\ntest_endpoint \"POST\" \"$BASE_URL/admin/roles\" \"401\" \"Create role (no auth)\"\n\n# Test with invalid auth\ntest_endpoint \"GET\" \"$BASE_URL/admin/moments\" \"401\" \"Moments with invalid auth\" \"Authorization: Bearer invalid-token\"\n\necho \"\"\necho \"üß™ Testing Node.js Test Suite\"\necho \"-----------------------------\"\n\n# Run the auth tests if npm is available\nif command -v npm >/dev/null 2>&1; then\n    echo \"Running auth test suite...\"\n    if npm test tests/auth-campaign.test.js >/dev/null 2>&1; then\n        echo -e \"Auth test suite... ${GREEN}‚úÖ PASS${NC}\"\n        ((PASSED++))\n    else\n        echo -e \"Auth test suite... ${RED}‚ùå FAIL${NC}\"\n        ((FAILED++))\n    fi\nelse\n    echo -e \"Auth test suite... ${YELLOW}‚ö†Ô∏è  SKIP${NC} (npm not available)\"\nfi\n\necho \"\"\necho \"üìã Testing Environment Variables\"\necho \"-------------------------------\"\n\n# Check required environment variables\nrequired_vars=(\"SUPABASE_URL\" \"SUPABASE_SERVICE_KEY\" \"SUPABASE_ANON_KEY\")\n\nfor var in \"${required_vars[@]}\"; do\n    if [ -n \"${!var:-}\" ]; then\n        echo -e \"$var is set... ${GREEN}‚úÖ PASS${NC}\"\n        ((PASSED++))\n    else\n        echo -e \"$var is set... ${RED}‚ùå FAIL${NC}\"\n        ((FAILED++))\n    fi\ndone\n\necho \"\"\necho \"üìä Test Results Summary\"\necho \"======================\"\necho -e \"${GREEN}‚úÖ Passed: $PASSED${NC}\"\necho -e \"${RED}‚ùå Failed: $FAILED${NC}\"\necho -e \"Total Tests: $((PASSED + FAILED))\"\n\nif [ $FAILED -eq 0 ]; then\n    echo -e \"\\n${GREEN}üéâ All RBAC tests passed! System is ready.${NC}\"\n    echo \"\"\n    echo \"Next steps:\"\n    echo \"1. Apply RBAC schema: Run supabase/rbac-complete.sql in Supabase SQL Editor\"\n    echo \"2. Apply RLS policies: Run supabase/rbac.sql in Supabase SQL Editor\"\n    echo \"3. Seed superadmin: Set SUPERADMIN_USER_ID and run ./scripts/seed_superadmin.sh\"\n    echo \"4. Test with real JWT: Use Supabase auth to get a valid JWT and test endpoints\"\n    exit 0\nelse\n    echo -e \"\\n${RED}‚ö†Ô∏è  Some RBAC tests failed. Please review the issues above.${NC}\"\n    exit 1\nfi